<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¯Ø§Ø±ÙˆØ¬Ùˆ â€” Ù†Ø³Ø®Ù‡Ù” Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ</title>
  <style>
    :root{--bg:#f6f8fb;--primary:#2b7a78;--accent:#f08a5d;--card:#fff;--muted:#6b6b6b}
    *{box-sizing:border-box;font-family: 'Segoe UI', Tahoma, sans-serif}
    body{margin:0;background:linear-gradient(180deg,#f6f8fb 0%,#eef6f6 100%);color:#222;min-height:100vh}
    .container{max-width:1100px;margin:30px auto;padding:20px}

    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:54px;height:54px;border-radius:12px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted)}

    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(30,40,50,0.06);margin-bottom:18px}

    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}

    .home-actions{display:flex;flex-direction:column;gap:12px}
    .role-btn{padding:14px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer;text-align:right;display:flex;flex-direction:column;align-items:flex-start}
    .role-btn:hover{background:rgba(43,122,120,0.05);border-color:var(--primary)}
    .role-btn strong{display:block;margin-bottom:4px}

    .auth{display:flex;flex-direction:column;gap:10px}
    .input{display:flex;flex-direction:column;gap:4px}
    .input label{font-size:14px;font-weight:500}
    input,select{padding:10px;border-radius:8px;border:1px solid #e2e8f0;font-size:14px}
    input:focus,select:focus{outline:none;border-color:var(--primary)}
    .row{display:flex;gap:10px}
    button.primary{background:var(--primary);color:#fff;padding:10px 20px;border-radius:8px;border:0;cursor:pointer;font-size:14px}
    button.primary:hover{background:#236663}
    button.primary:disabled{background:#ccc;cursor:not-allowed}
    button.ghost{background:transparent;border:1px solid #ddd;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px}
    button.ghost:hover{background:#f5f5f5}

    .small{font-size:13px;color:var(--muted)}
    .pharm-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .pharm-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;border:1px solid #eef3f3}

    .patient-area{display:none;flex-direction:column;gap:12px}
    .patient-area.active{display:flex}

    .presc-form{display:flex;flex-direction:column;gap:10px}

    .pharmacy-area{display:none;flex-direction:column;gap:12px}
    .pharmacy-area.active{display:flex}
    .presc-card{padding:12px;border-radius:8px;border:1px dashed #e3eef0;display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
    .presc-card-header{display:flex;justify-content:space-between;align-items:center}

    .notif{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#222;color:#fff;padding:12px 16px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.25);z-index:1000;display:none}
    .notif.show{display:block}
    .notif.error{background:#dc2626}
    .notif.success{background:#059669}

    .center{display:flex;flex-direction:column;align-items:center;justify-content:center}

    .loader-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:999}
    .loader-overlay.active{display:flex}
    .loader{background:#fff;padding:24px;border-radius:12px;min-width:320px;text-align:center}
    .countdown{font-weight:700;font-size:28px;margin-top:8px;color:var(--primary)}

    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}

    .status-badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:500}
    .status-pending{background:#fef3c7;color:#92400e}
    .status-accepted{background:#d1fae5;color:#065f46}
    .status-paid{background:#dbeafe;color:#1e40af}
    .status-ready{background:#e0e7ff;color:#3730a3}

    #patientAuthTabs, #pharmAuthTabs{display:flex;gap:8px;margin-bottom:12px}
    #patientAuthTabs button, #pharmAuthTabs button{flex:1}

    @media(max-width:900px){
      .grid{grid-template-columns:1fr}
      header{flex-direction:column;align-items:flex-start;gap:8px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">Ø¯</div>
        <div>
          <h1>Ø¯Ø§Ø±ÙˆØ¬Ùˆ</h1>
          <p class="lead">Ù¾Ù„ØªÙØ±Ù…Ù Ø³ÙØ§Ø±Ø´ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø±Ùˆ Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø± Ùˆ Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡</p>
        </div>
      </div>
      <div class="small">Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ â€” Ù…ØªØµÙ„ Ø¨Ù‡ Backend</div>
    </header>

    <div class="grid">
      <div class="card">
        <h3>Ø®Ø§Ù†Ù‡</h3>
        <div style="height:10px"></div>
        <div class="home-actions">
          <button class="role-btn" id="openPatient">
            <strong>ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø±</strong>
            <small class="small">Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ø³Ø®Ù‡ Ùˆ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø§Ø±Ùˆ</small>
          </button>
          <button class="role-btn" id="openPharmacy">
            <strong>ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡</strong>
            <small class="small">Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø³Ø®Ù‡ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ</small>
          </button>
          <div class="small">Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø¨Ù‡ Backend Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª 3000 Ù…ØªØµÙ„ Ø§Ø³Øª.</div>
        </div>

        <div style="margin-top:18px">
          <div class="patient-area card" id="patientArea">
            <h4>Ø¨ÛŒÙ…Ø§Ø± â€” ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h4>
            <div class="auth">
              <div id="patientAuthTabs">
                <button class="ghost" id="pLoginBtn">ÙˆØ±ÙˆØ¯</button>
                <button class="ghost" id="pSignupBtn">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
              </div>

              <div id="pLoginForm" style="display:none">
                <div class="input"><label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</label><input id="pLoginPhone" placeholder="09xxxxxxxx" /></div>
                <div class="input"><label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label><input id="pLoginPass" type="password" /></div>
                <div class="row"><button class="primary" id="pDoLogin">ÙˆØ±ÙˆØ¯</button><button class="ghost" id="pBack">Ø¨Ø§Ø²Ú¯Ø´Øª</button></div>
              </div>

              <div id="pSignupForm" style="display:none">
                <div class="input"><label>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label><input id="pName" /></div>
                <div class="input"><label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</label><input id="pPhone" placeholder="09xxxxxxxx" /></div>
                <div class="input"><label>Ø´Ù‡Ø±</label><input id="pCity" /></div>
                <div class="input"><label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label><input id="pPass" type="password" /></div>
                <div class="row"><button class="primary" id="pDoSignup">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button><button class="ghost" id="pBack2">Ø¨Ø§Ø²Ú¯Ø´Øª</button></div>
              </div>
            </div>

            <div id="patientDashboard" style="display:none">
              <h4>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ <span id="pDisplayName"></span></h4>
              <div class="presc-form">
                <div class="input"><label>Ú©Ø¯ Ù†Ø³Ø®Ù‡</label><input id="prescCode" placeholder="Ù…Ø«Ø§Ù„: ABC-123" /></div>
                <div class="input"><label>Ø´Ù…Ø§Ø±Ù‡ Ø´Ù†Ø§Ø³Ù‡</label><input id="prescId" placeholder="Ù…Ø«Ø§Ù„: 987654321" /></div>
                <div class="input"><label>Ù†ÙˆØ¹ Ø¨ÛŒÙ…Ù‡</label>
                  <select id="insType">
                    <option>ØªØ£Ù…ÛŒÙ† Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ</option>
                    <option>Ø®Ø¯Ù…Ø§Øª Ø¯Ø±Ù…Ø§Ù†ÛŒ</option>
                    <option>Ù†ÛŒØ±ÙˆÙ‡Ø§ÛŒ Ù…Ø³Ù„Ø­</option>
                    <option>Ø¬Ø§Ù†Ø¨Ø§Ø²Ø§Ù†</option>
                  </select>
                </div>
                <div class="row"><button class="primary" id="searchPresc">Ø§Ø±Ø³Ø§Ù„ Ù†Ø³Ø®Ù‡</button><button class="ghost" id="pLogout">Ø®Ø±ÙˆØ¬</button></div>
              </div>

              <div style="height:12px"></div>
              <h5>Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†</h5>
              <div id="myPrescriptions"></div>
            </div>
          </div>

          <div class="pharmacy-area card" id="pharmacyArea">
            <h4>Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡ â€” ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h4>
            <div class="auth">
              <div id="pharmAuthTabs">
                <button class="ghost" id="phLoginBtn">ÙˆØ±ÙˆØ¯</button>
                <button class="ghost" id="phSignupBtn">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
              </div>

              <div id="phLoginForm" style="display:none">
                <div class="input"><label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label><input id="phLoginUser" /></div>
                <div class="input"><label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label><input id="phLoginPass" type="password" /></div>
                <div class="row"><button class="primary" id="phDoLogin">ÙˆØ±ÙˆØ¯</button><button class="ghost" id="phBack">Ø¨Ø§Ø²Ú¯Ø´Øª</button></div>
              </div>

              <div id="phSignupForm" style="display:none">
                <div class="input"><label>Ù†Ø§Ù… Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡</label><input id="phName" /></div>
                <div class="input"><label>Ø´Ù‡Ø±</label><input id="phCity" /></div>
                <div class="input"><label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</label><input id="phPhone" /></div>
                <div class="input"><label>Ù†Ø§Ù… Ù…Ø¯ÛŒØ±</label><input id="phManager" /></div>
                <div class="input"><label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label><input id="phUser" /></div>
                <div class="input"><label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label><input id="phPass" type="password" /></div>
                <div class="row"><button class="primary" id="phDoSignup">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button><button class="ghost" id="phBack2">Ø¨Ø§Ø²Ú¯Ø´Øª</button></div>
              </div>

              <div id="pharmacyDashboard" style="display:none">
                <h4>Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡: <span id="phDisplayName"></span></h4>
                <div>
                  <h5>Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ</h5>
                  <button class="ghost" onclick="loadIncomingPrescriptions()" style="margin-bottom:10px">ğŸ”„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯</button>
                  <div id="incomingPrescriptions"></div>
                </div>
                <div style="height:10px"></div>
                <button class="ghost" id="phLogout">Ø®Ø±ÙˆØ¬</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Ø±Ø§Ù‡Ù†Ù…Ø§</h3>
        <p class="small">ÙÙ„Ø¤ Ú©Ø§Ø±ÛŒ Ø³Ø§Ø¯Ù‡:</p>
        <ol>
          <li>Ø¨ÛŒÙ…Ø§Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ú©Ø¯ Ù†Ø³Ø®Ù‡ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</li>
          <li>Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡â€ŒÙ‡Ø§ Ù†Ø³Ø®Ù‡ Ø±Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù†Ø¯ Ùˆ Ø¯Ø± ØµÙˆØ±Øª Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù‚Ø¨ÙˆÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯.</li>
          <li>Ø¨ÛŒÙ…Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ ØµÙØ­Ù‡Ù” "Ø¯Ø§Ø±Ùˆ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ" Ø¨Ø§ ØªØ§ÛŒÙ…Ø± Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ø¯.</li>
        </ol>

        <div style="margin-top:12px">
          <h4>Ú†Ù†Ø¯ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</h4>
          <ul>
            <li class="small">Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø¨Ù‡ Backend API Ø±ÙˆÛŒ http://localhost:3000 Ù…ØªØµÙ„ Ø§Ø³Øª.</li>
            <li class="small">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± ÙØ§ÛŒÙ„ db.json Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</li>
            <li class="small">Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Backend Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª.</li>
          </ul>
        </div>
      </div>
    </div>

    <footer>Ù†Ø³Ø®Ù‡Ù” Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ â€” Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡Ù” Ø§ÙˆÙ„ÛŒÙ‡</footer>
  </div>

  <div class="loader-overlay" id="loaderOverlay">
    <div class="loader card center">
      <div id="loaderTitle">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ø³Ø®Ù‡...</div>
      <div class="countdown" id="loaderTimer">00:00</div>
      <div style="height:10px"></div>
      <button class="primary" id="closeLoader">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>

  <div id="notif" class="notif"></div>

  <script>
    const API_BASE = "http://localhost:3000/api";
    let currentPatient = null;
    let currentPharmacy = null;
    let prescriptionCheckInterval = null;

    // Helper functions
    async function apiCall(endpoint, method = 'GET', data = null) {
      try {
        const options = {
          method,
          headers: { 'Content-Type': 'application/json' }
        };
        if (data) options.body = JSON.stringify(data);
        
        const response = await fetch(`${API_BASE}${endpoint}`, options);
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
        }
        
        return result;
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    function showNotif(msg, type = 'success') {
      const notif = document.getElementById('notif');
      notif.textContent = msg;
      notif.className = `notif ${type} show`;
      setTimeout(() => notif.classList.remove('show'), 3000);
    }

    // Patient functions
    document.getElementById('openPatient').addEventListener('click', () => {
      document.getElementById('patientArea').classList.add('active');
      document.getElementById('pharmacyArea').classList.remove('active');
    });

    document.getElementById('pLoginBtn').addEventListener('click', () => {
      document.getElementById('pLoginForm').style.display = 'block';
      document.getElementById('pSignupForm').style.display = 'none';
    });

    document.getElementById('pSignupBtn').addEventListener('click', () => {
      document.getElementById('pLoginForm').style.display = 'none';
      document.getElementById('pSignupForm').style.display = 'block';
    });

    document.getElementById('pBack').addEventListener('click', () => {
      document.getElementById('pLoginForm').style.display = 'none';
    });

    document.getElementById('pBack2').addEventListener('click', () => {
      document.getElementById('pSignupForm').style.display = 'none';
    });

    document.getElementById('pDoSignup').addEventListener('click', async () => {
      const name = document.getElementById('pName').value;
      const phone = document.getElementById('pPhone').value;
      const city = document.getElementById('pCity').value;
      const password = document.getElementById('pPass').value;

      if (!name || !phone || !city || !password) {
        showNotif('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
        return;
      }

      try {
        const result = await apiCall('/patient/signup', 'POST', { name, phone, city, password });
        currentPatient = result.patient;
        showNotif('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
        showPatientDashboard(result.patient);
      } catch (error) {
        showNotif(error.message, 'error');
      }
    });

    document.getElementById('pDoLogin').addEventListener('click', async () => {
      const phone = document.getElementById('pLoginPhone').value;
      const password = document.getElementById('pLoginPass').value;

      if (!phone || !password) {
        showNotif('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
        return;
      }

      try {
        const result = await apiCall('/patient/login', 'POST', { phone, password });
        currentPatient = result.patient;
        showNotif('Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯');
        showPatientDashboard(result.patient);
      } catch (error) {
        showNotif(error.message, 'error');
      }
    });

    function showPatientDashboard(patient) {
      document.getElementById('pLoginForm').style.display = 'none';
      document.getElementById('pSignupForm').style.display = 'none';
      document.getElementById('patientDashboard').style.display = 'block';
      document.getElementById('pDisplayName').textContent = patient.name;
      loadMyPrescriptions(patient.id);
      startPrescriptionPolling(patient.id);
    }

    document.getElementById('searchPresc').addEventListener('click', async () => {
      const code = document.getElementById('prescCode').value;
      const idNumber = document.getElementById('prescId').value;
      const insurance = document.getElementById('insType').value;

      if (!code || !idNumber) {
        showNotif('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù†Ø³Ø®Ù‡ Ùˆ Ø´Ù…Ø§Ø±Ù‡ Ø´Ù†Ø§Ø³Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }

      try {
        await apiCall('/prescription/create', 'POST', {
          patientId: currentPatient.id,
          code,
          idNumber,
          insurance
        });

        showNotif('Ù†Ø³Ø®Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯');
        document.getElementById('prescCode').value = '';
        document.getElementById('prescId').value = '';
        loadMyPrescriptions(currentPatient.id);
      } catch (error) {
        showNotif(error.message, 'error');
      }
    });

    async function loadMyPrescriptions(patientId) {
      try {
        const prescriptions = await apiCall('/prescription');
        const myPrescs = prescriptions.filter(p => p.patientId === patientId);
        const container = document.getElementById('myPrescriptions');

        if (myPrescs.length === 0) {
          container.innerHTML = '<p class="small">Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ù†Ø³Ø®Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</p>';
          return;
        }

        container.innerHTML = myPrescs.map(p => `
          <div class="presc-card">
            <div class="presc-card-header">
              <div>
                <strong>Ú©Ø¯ Ù†Ø³Ø®Ù‡: ${p.code}</strong>
                <p class="small">Ø¨ÛŒÙ…Ù‡: ${p.insurance}</p>
                <p class="small">Ø´Ù…Ø§Ø±Ù‡ Ø´Ù†Ø§Ø³Ù‡: ${p.idNumber}</p>
              </div>
              <span class="status-badge status-${p.status}">
                ${p.status === 'pending' ? 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±' : p.status === 'accepted' ? 'Ù‚Ø¨ÙˆÙ„ Ø´Ø¯Ù‡' : p.status === 'paid' ? 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡' : 'Ø¢Ù…Ø§Ø¯Ù‡'}
              </span>
            </div>
            ${p.matchedPharmacy ? `<p class="small">Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡: Ø´Ù†Ø§Ø³Ù‡ ${p.matchedPharmacy}</p>` : ''}
            ${p.status === 'accepted' ? `<button class="primary" onclick="payPrescription('${p.id}')">Ù¾Ø±Ø¯Ø§Ø®Øª</button>` : ''}
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading prescriptions:', error);
      }
    }

    function startPrescriptionPolling(patientId) {
      if (prescriptionCheckInterval) {
        clearInterval(prescriptionCheckInterval);
      }
      prescriptionCheckInterval = setInterval(() => {
        loadMyPrescriptions(patientId);
      }, 5000);
    }

    window.payPrescription = async function(prescId) {
      try {
        await apiCall('/prescription/pay', 'POST', { presId: prescId });
        showNotif('Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
        loadMyPrescriptions(currentPatient.id);
        showLoader();
      } catch (error) {
        showNotif(error.message, 'error');
      }
    };

    function showLoader() {
      document.getElementById('loaderOverlay').classList.add('active');
      let seconds = 180;

      const interval = setInterval(() => {
        seconds--;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById('loaderTimer').textContent = 
          `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

        if (seconds <= 0) {
          clearInterval(interval);
          document.getElementById('loaderTitle').textContent = 'Ù†Ø³Ø®Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª! âœ…';
        }
      }, 1000);
    }

    document.getElementById('closeLoader').addEventListener('click', () => {
      document.getElementById('loaderOverlay').classList.remove('active');
    });

    document.getElementById('pLogout').addEventListener('click', () => {
      currentPatient = null;
      if (prescriptionCheckInterval) {
        clearInterval(prescriptionCheckInterval);
      }
      document.getElementById('patientDashboard').style.display = 'none';
      document.getElementById('patientArea').classList.remove('active');
      showNotif('Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚');
    });

    // Pharmacy functions
    document.getElementById('openPharmacy').addEventListener('click', () => {
      document.getElementById('pharmacyArea').classList.add('active');
      document.getElementById('patientArea').classList.remove('active');
    });

    document.getElementById('phLoginBtn').addEventListener('click', () => {
      document.getElementById('phLoginForm').style.display = 'block';
      document.getElementById('phSignupForm').style.display = 'none';
    });

    document.getElementById('phSignupBtn').addEventListener('click', () => {
      document.getElementById('phLoginForm').style.display = 'none';
      document.getElementById('phSignupForm').style.display = 'block';
    });

    document.getElementById('phBack').addEventListener('click', () => {
      document.getElementById('phLoginForm').style.display = 'none';
    });

    document.getElementById('phBack2').addEventListener('click', () => {
      document.getElementById('phSignupForm').style.display = 'none';
    });

    document.getElementById('phDoSignup').addEventListener('click', async () => {
      const name = document.getElementById('phName').value;
      const city = document.getElementById('phCity').value;
      const phone = document.getElementById('phPhone').value;
      const manager = document.getElementById('phManager').value;
      const username = document.getElementById('phUser').value;
      const password = document.getElementById('phPass').value;

      if (!name || !city || !phone || !manager || !username || !password) {
        showNotif('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
        return;
      }

      try {
        const result = await apiCall('/pharmacy/signup', 'POST', {
          name, city, phone, manager, username, password
        });
        currentPharmacy = result.pharmacy;
        showNotif('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
        showPharmacyDashboard(result.pharmacy);
      } catch (error) {
        showNotif(error.message, 'error');
      }
    });

    document.getElementById('phDoLogin').addEventListener('click', async () => {
      const username = document.getElementById('phLoginUser').value;
      const password = document.getElementById('phLoginPass').value;

      if (!username || !password) {
        showNotif('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
        return;
      }

      try {
        const result = await apiCall('/pharmacy/login', 'POST', { username, password });
        currentPharmacy = result.pharmacy;
        showNotif('Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯');
        showPharmacyDashboard(result.pharmacy);
      } catch (error) {
        showNotif(error.message, 'error');
      }
    });

    function showPharmacyDashboard(pharmacy) {
      document.getElementById('phLoginForm').style.display = 'none';
      document.getElementById('phSignupForm').style.display = 'none';
      document.getElementById('pharmacyDashboard').style.display = 'block';
      document.getElementById('phDisplayName').textContent = pharmacy.name;
      loadIncomingPrescriptions();
      startPharmacyPolling();
    }

    async function loadIncomingPrescriptions() {
      try {
        const prescriptions = await apiCall('/prescription');
        const pending = prescriptions.filter(p => p.status === 'pending');
        const container = document.getElementById('incomingPrescriptions');

        if (pending.length === 0) {
          container.innerHTML = '<p class="small">Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù†Ø³Ø®Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù†ÛŒØ³Øª</p>';
          return;
        }

        container.innerHTML = pending.map(p => `
          <div class="presc-card">
            <strong>Ú©Ø¯ Ù†Ø³Ø®Ù‡: ${p.code}</strong>
            <p class="small">Ø´Ù…Ø§Ø±Ù‡ Ø´Ù†Ø§Ø³Ù‡: ${p.idNumber}</p>
            <p class="small">Ø¨ÛŒÙ…Ù‡: ${p.insurance}</p>
            <p class="small">Ø´Ù†Ø§Ø³Ù‡ Ø¨ÛŒÙ…Ø§Ø±: ${p.patientId}</p>
            <button class="primary" onclick="acceptPrescription('${p.id}')">Ù‚Ø¨ÙˆÙ„ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading prescriptions:', error);
      }
    }

    function startPharmacyPolling() {
      if (prescriptionCheckInterval) {
        clearInterval(prescriptionCheckInterval);
      }
      prescriptionCheckInterval = setInterval(() => {
        loadIncomingPrescriptions();
      }, 5000);
    }

    window.acceptPrescription = async function(prescId) {
      try {
        await apiCall('/prescription/accept', 'POST', {
          presId: prescId,
          pharmacyId: currentPharmacy.id
        });
        showNotif('Ù†Ø³Ø®Ù‡ Ù‚Ø¨ÙˆÙ„ Ø´Ø¯');
        loadIncomingPrescriptions();
      } catch (error) {
        showNotif(error.message, 'error');
      }
    };

    document.getElementById('phLogout').addEventListener('click', () => {
      currentPharmacy = null;
      if (prescriptionCheckInterval) {
        clearInterval(prescriptionCheckInterval);
      }
      document.getElementById('pharmacyDashboard').style.display = 'none';
      document.getElementById('pharmacyArea').classList.remove('active');
      showNotif('Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚');
    });
  </script>
</body>
</html>